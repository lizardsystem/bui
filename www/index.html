<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="js/bootstrap/bootstrap/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="js/openlayers/theme/default/style.css">
        <link rel="stylesheet" type="text/css" href="js/dragdealer/dragdealer.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <title>Regenradar</title>
    </head>
    <body>
        <div id="magnifier" class="dragdealer rounded-cornered">
            <div class="red-bar handle">
                <div id="clock" class="red-bar" style="z-index: 9999999;"></div>
                <div id="stretch-bar" class="red-bar stretch-bar"></div>
            </div>
        </div>
        <div id="map"></div>
        
        <!--<script type="text/javascript" src="phonegap.js"></script>-->
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript" src="js/jquery/jquery.min.js"></script>
        <script type="text/javascript" src="js/bootstrap/bootstrap/js/bootstrap.min.js"></script>
        <script src="js/openlayers/OpenLayers.js"></script>
        <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.3"></script>
        <script type="text/javascript" src="js/momentjs/moment.js"></script>
        <script type="text/javascript" src="js/dragdealer/dragdealer.js"></script>
        
        <style>
            @media screen
            {
                #map { width: 100%; height:100%;}
            }
         </style>        
        <script type="text/javascript">

            // onSuccess Callback
            // This method accepts a Position object, which contains the
            // current GPS coordinates
            //
            var onSuccess = function(position) {
                map.setCenter(
                    new OpenLayers.LonLat(position.coords.longitude, position.coords.latitude).transform(
                        new OpenLayers.Projection("EPSG:4326"),
                        map.getProjectionObject()
                    ),
                11);
                
                console.debug('Latitude: '          + position.coords.latitude          + '\n' +
                      'Longitude: '         + position.coords.longitude         + '\n' +
                      'Altitude: '          + position.coords.altitude          + '\n' +
                      'Accuracy: '          + position.coords.accuracy          + '\n' +
                      'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
                      'Heading: '           + position.coords.heading           + '\n' +
                      'Speed: '             + position.coords.speed             + '\n' +
                      'Timestamp: '         + position.timestamp                + '\n');
            };

            // onError Callback receives a PositionError object
            //
            function onError(error) {
                alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
                return true; // fail silently...
            }

            navigator.geolocation.getCurrentPosition(onSuccess, onError);


            (function () {
                var map = null;
                var lizard_neerslagradar = lizard_neerslagradar || {};
                lizard_neerslagradar.wms_base_url = 'http://regenradar.lizard.net/wms/';
                lizard_neerslagradar.fixed_image_layer_bbox = '147419.974, 6416139.595, 1001045.904, 7224238.809';
                // Debug info: number of hours is 3
                var animationDatetimes = [];
                var now = moment();
                console.debug("nu = ", now.format('YYYY-MM-DDTHH:mm:ss'));
                now.minutes((Math.round(now.minutes()/5) * 5) % 60);
                now.seconds(0);
                console.debug("rounded = ", now.format('YYYY-MM-DDTHH:mm:ss'));
                for (var interval=5; interval < 240; interval=interval+5) {
                    var animationDatetime =  now.subtract('minutes', 5);
                    console.debug(interval, animationDatetime.format('YYYY-MM-DDTHH:mm:ss'));
                    var UtsieAniDatetime = moment.utc(animationDatetime);
                    animationDatetimes.push(UtsieAniDatetime.format('YYYY-MM-DDTHH:mm:ss') + '.000Z');
                };
                animationDatetimes.reverse();
                console.debug(animationDatetimes);
                console.debug(UtsieAniDatetime);
                console.debug(animationDatetime);

                function MyLayer (dt, opacity, bbox) {
                    this.dt = dt;
                    this.opacity = opacity;
                    this.bbox = bbox;
                    this.ol_layer = null;
                }

                var CssHideableWMS = OpenLayers.Class(OpenLayers.Layer.WMS, {
                    cssVisibility: true,

                    initialize: function (name, url, params, options) {
                        OpenLayers.Layer.WMS.prototype.initialize.apply(
                            this, [name, url, params, options]);
                        if (options.cssVisibility === true || options.cssVisibility === false) {
                            this.cssVisibility = options.cssVisibility;
                        }
                        this.events.on({
                            'added': this.updateCssVisibility,
                            'moveend': this.updateCssVisibility,
                            scope: this});
                    },

                    destroy: function () {
                        this.events.un({
                            'added': this.updateCssVisibility,
                            'moveend': this.updateCssVisibility,
                            scope: this});
                        OpenLayers.Layer.WMS.prototype.destroy.apply(this);
                    },

                    setCssVisibility: function (visible) {
                        this.cssVisibility = visible;
                        this.updateCssVisibility();
                    },

                    updateCssVisibility: function () {
                        if (this.div) {
                            if (this.cssVisibility) {
                                $(this.div).show();
                            }
                            else {
                                $(this.div).hide();
                            }
                        }
                    }
                });

                var CssHideableImageLayer = OpenLayers.Class(OpenLayers.Layer.Image, {
                    cssVisibility: true,

                    initialize: function (name, url, extent, size, options) {
                        OpenLayers.Layer.Image.prototype.initialize.apply(
                            this, [name, url, extent, size, options]);
                        if (options.cssVisibility === true || options.cssVisibility === false) {
                            this.cssVisibility = options.cssVisibility;
                        }
                        this.events.on({
                            'added': this.updateCssVisibility,
                            'moveend': this.updateCssVisibility,
                            scope: this});
                    },

                    destroy: function () {
                        this.events.un({
                            'added': this.updateCssVisibility,
                            'moveend': this.updateCssVisibility,
                            scope: this});
                        OpenLayers.Layer.Image.prototype.destroy.apply(this);
                    },

                    setCssVisibility: function (visible) {
                        this.cssVisibility = visible;
                        this.updateCssVisibility();
                    },

                    updateCssVisibility: function () {
                        if (this.div) {
                            if (this.cssVisibility) {
                                $(this.div).show();
                            }
                            else {
                                $(this.div).hide();
                            }
                        }
                    }
                });

                var interval_ms = 100;
                var cycle_layers_interval = null;
                var current_layer_idx = -1;
                var paused_at_end = false;
                var is_first_load = true;

                var layers = [];
                var regional_layers = [];

                var full_bbox = new OpenLayers.Bounds(
                    lizard_neerslagradar.fixed_image_layer_bbox.split(','));

                var regional_bbox;
                if (lizard_neerslagradar.user_logged_in) {
                    regional_bbox = new OpenLayers.Bounds(
                        lizard_neerslagradar.region_bbox.split(','));
                }

                for (var i=0; i < animationDatetimes.length; i++) {
                    var dt = animationDatetimes[i];
                    layers.push(new MyLayer(dt, 0.6, full_bbox));
                }

                var layers_loading = 0;
                var progress_interval = null;

                function set_layer (layer_idx) {
                    if (current_layer_idx != layer_idx) {
                        // swap out visibility
                        if (current_layer_idx != -1) {
                            var current_layer = layers[current_layer_idx];
                            current_layer.ol_layer.setCssVisibility(false);
                        }
                        if (layer_idx != -1) {
                            var layer = layers[layer_idx];
                            layer.ol_layer.setCssVisibility(true);
                            console.debug("Switch to layer: ", layer)
                        }

                        // update with next layer index
                        current_layer_idx = layer_idx;
                    }
                }

                function cycle_layers () {
                    var current_layer = layers[current_layer_idx];
                    // don't swap layers when we're still loading
                    if ((!current_layer || !current_layer.ol_layer.loading) &&
                        (!paused_at_end) &&
                        (!lizard_neerslagradar.user_logged_in ||
                         !regional_layer ||
                         !regional_layer.ol_layer.loading)) {
                        // figure out next layer
                        var next_layer_idx = (current_layer_idx >= layers.length - 1) ? 0 : current_layer_idx + 1;
                        if (next_layer_idx === 0) {
                            set_layer(next_layer_idx);
                            slider.setStep(next_layer_idx, {snap: true});
                            console.debug("0!: ", next_layer_idx)
                        }
                        else {
                            set_layer(next_layer_idx);
                            slider.setStep(next_layer_idx+1);
                        }
                    }
                }

                function init_cycle_layers () {
                    var init_layer = function (idx, layer) {
                        var dt_iso_8601 = layer.dt;
                        var wms_params = {
                            WIDTH: 525,
                            HEIGHT: 497,
                            SRS: 'EPSG:3857',
                            BBOX: layer.bbox.toBBOX(),
                            TIME: dt_iso_8601
                        };
                        var wms_url = lizard_neerslagradar.wms_base_url + '?' + $.param(wms_params);
                        var ol_layer = new CssHideableImageLayer(
                            'L' + idx,
                            wms_url,
                            layer.bbox,
                            new OpenLayers.Size(525, 497),
                            {
                                isBaseLayer: false,
                                alwaysInRange: true,
                                visibility: true, // keep this, so all layers are preloaded in the browser
                                cssVisibility: false, // hide layer again with this custom option
                                displayInLayerSwitcher: false,
                                metadata: layer,
                                opacity: layer.opacity,
                                eventListeners: {
                                    'loadstart': function () {
                                        layers_loading++;
                                        on_layer_loading_change();
                                    },
                                    'loadend': function () {
                                        layers_loading--;
                                        on_layer_loading_change();
                                    }
                                },
                                projection: 'EPSG:3857'
                            }
                        );
                        map.addLayer(ol_layer);
                        layer.ol_layer = ol_layer;
                    };
                    $.each(layers, init_layer);
                }

                function init_slider () {
                    console.log("layers: ", layers.length);
                    window.slider = new Dragdealer('magnifier',
                    {
                        steps: layers.length -1,
                        snap: false,
                        loose: true,
                        speed: 100,
                        animationCallback: function(x, y)
                        {
                            clock.innerHTML = current_layer_idx + 2;
                        },
                        callback: function (x, y) {
                            //set_layer(x-1);
                        }

                    });
                };
                    var clock = document.getElementById('clock');

                function start_if_first_load () {
                    if (is_first_load) {
                        start();
                        is_first_load = false;
                    }
                }

                function start () {
                    cycle_layers_interval = setInterval(cycle_layers, interval_ms);
                }

                function stop () {
                    clearInterval(cycle_layers_interval);
                    cycle_layers_interval = null;
                }

                function stop_if_running () {
                    if (is_running()) {
                        stop();
                    }
                }

                function is_running () {
                    return cycle_layers_interval !== null;
                }

                function toggle () {
                    if (is_running()) {
                        stop();
                    }
                    else {
                        start();
                    }
                }

                function init_button () {
                    $btn = $('#magnifier');
                    $btn.click(function (e) {
                        toggle();
                    });
                }

                function on_layer_loading_change () {
                    if (layers_loading > 0) {
                        // 'if' control structure split for clarity
                        if (progress_interval === null) {
                            set_progress(0);
                            progress_interval = setInterval(update_progress, 300);
                        }
                    }
                    else {
                        if (progress_interval !== null) {
                            clearInterval(progress_interval);
                            progress_interval = null;
                            set_progress(1);
                        }
                    }
                }

                function update_progress () {
                    var num_loading_tiles = 0;
                    var num_tiles = 0;
                    var ratio;
                    // sum numLoadingTiles and total amount of tiles per layer
                    $.each(layers, function (idx, layer) {
                        if (layer.ol_layer && layer.ol_layer.grid) {
                            num_loading_tiles += layer.ol_layer.numLoadingTiles;
                            for (var i=0; i<layer.ol_layer.grid.length; i++) {
                                num_tiles += layer.ol_layer.grid[i].length;
                            }
                        }
                    });
                    if (num_tiles > 0) {
                        ratio = 1 - num_loading_tiles / num_tiles;
                        set_progress(ratio);
                    }
                    else {
                        // no tiled/gridded layers
                        ratio = 1 - layers_loading / layers.length;
                        set_progress(ratio);
                    }
                }

                function set_progress (ratio) {
                    // clamp ratio
                    if (ratio < 0) ratio = 0;
                    if (ratio >= 1) ratio = 1;

                    var is_ready = ratio == 1;
                    if (is_ready) {
                        $btn.removeAttr('disabled');
                        //$slider.slider('enable');
                        start_if_first_load();
                    }
                    else {
                        $btn.attr('disabled', 'disabled');
                        //$slider.slider('disable');
                    }
                }

                function wait_until_first_layer_loaded () {
                    var wait_interval;
                    var tick = function () {
                        if (layers[0] && layers[0].ol_layer && !layers[0].ol_layer.loading) {
                            set_layer(0);
                            // stop self
                            clearInterval(wait_interval);
                        }
                    };
                    wait_interval = setInterval(tick, 100);
                }

                function init_map () {
                    map = new OpenLayers.Map('map', {
                        theme: null
                    });
                    window.map = map;
                    
                    var grey = new OpenLayers.Layer.XYZ(
                    "Dark Grey",
                    [
                        "http://a.tiles.mapbox.com/v3/examples.map-cnkhv76j/${z}/${x}/${y}.png",
                        "http://b.tiles.mapbox.com/v3/examples.map-cnkhv76j/${z}/${x}/${y}.png",
                        "http://c.tiles.mapbox.com/v3/examples.map-cnkhv76j/${z}/${x}/${y}.png",
                        "http://d.tiles.mapbox.com/v3/examples.map-cnkhv76j/${z}/${x}/${y}.png"
                    ], {
                        attribution: "Tiles &copy; <a href='http://mapbox.com/'>MapBox</a>",
                        sphericalMercator: true,
                        wrapDateLine: true,
                        //numZoomLevels: 5
                    }
                    );

                    map.addLayer(grey);
                    //map.zoomToMaxExtent();
                    map.setCenter(
                        new OpenLayers.LonLat(5.5698782, 52.0992287).transform(
                            new OpenLayers.Projection("EPSG:4326"),
                            map.getProjectionObject()
                        ),
                    8);
                }

                function init_neerslagradar () {
                    init_map();
                    //init_overview();
                    init_button();
                    init_slider();
                    //init_progress();
                    init_cycle_layers();
                    wait_until_first_layer_loaded();


                }

                $(document).ready(init_neerslagradar);
            })();



            app.initialize();
        </script>
    </body>
</html>
